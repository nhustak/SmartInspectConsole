<Window x:Class="SmartInspectConsole.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:SmartInspectConsole"
        xmlns:vm="clr-namespace:SmartInspectConsole.ViewModels"
        xmlns:conv="clr-namespace:SmartInspectConsole.Converters"
        xmlns:views="clr-namespace:SmartInspectConsole.Views"
        xmlns:behaviors="clr-namespace:SmartInspectConsole.Behaviors"
        mc:Ignorable="d"
        Title="SmartInspect Console"
        Height="800" Width="1200"
        WindowStartupLocation="CenterScreen"
        Background="{DynamicResource BackgroundBrush}"
        Foreground="{DynamicResource ForegroundBrush}">

    <Window.Resources>
        <conv:LogEntryTypeToIconConverter x:Key="LogEntryTypeToIconConverter"/>
        <conv:LogEntryTypeToColorConverter x:Key="LogEntryTypeToColorConverter"/>
        <conv:ColorToBrushConverter x:Key="ColorToBrushConverter"/>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <conv:BoolToGridLengthConverter x:Key="BoolToGridLengthConverter"/>
        <conv:BoolToColumnWidthConverter x:Key="BoolToColumnWidthConverter"/>
        <conv:LogEntryToIsSeparatorConverter x:Key="LogEntryToIsSeparatorConverter"/>

        <!-- Local styles that use DynamicResource for theme switching -->
        <Style TargetType="GroupBox">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="Padding" Value="4"/>
        </Style>

        <Style TargetType="ListView">
            <Setter Property="Background" Value="{DynamicResource BackgroundBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
        </Style>

        <Style TargetType="ListViewItem">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="Padding" Value="4,2"/>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{DynamicResource HoverBrush}"/>
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{DynamicResource SelectionBrush}"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="GridViewColumnHeader">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="Padding" Value="8,4"/>
        </Style>

        <Style TargetType="TextBox">
            <Setter Property="Background" Value="{DynamicResource BackgroundBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="CaretBrush" Value="{DynamicResource ForegroundBrush}"/>
            <Setter Property="Padding" Value="4,2"/>
        </Style>

        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
        </Style>

        <Style TargetType="Button">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="1"
                                Padding="{TemplateBinding Padding}"
                                CornerRadius="2">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{DynamicResource HoverBrush}"/>
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter Property="Background" Value="{DynamicResource AccentBrush}"/>
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="TabControl">
            <Setter Property="Background" Value="{DynamicResource BackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
        </Style>

        <Style TargetType="TabItem">
            <Setter Property="Background" Value="{DynamicResource SurfaceBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource BorderBrush}"/>
            <Setter Property="Padding" Value="14,8"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="TabItem">
                        <Grid>
                            <Border x:Name="Border"
                                    Background="{DynamicResource SurfaceBrush}"
                                    BorderBrush="{DynamicResource BorderBrush}"
                                    BorderThickness="1,1,1,0"
                                    CornerRadius="4,4,0,0"
                                    Margin="2,0,0,0"
                                    Padding="{TemplateBinding Padding}">
                                <ContentPresenter x:Name="ContentSite"
                                                  ContentSource="Header"
                                                  HorizontalAlignment="Center"
                                                  VerticalAlignment="Center"/>
                            </Border>
                            <!-- Active tab indicator bar -->
                            <Border x:Name="ActiveIndicator"
                                    Height="3"
                                    VerticalAlignment="Top"
                                    Margin="3,1,1,0"
                                    CornerRadius="2,2,0,0"
                                    Background="#2196F3"
                                    Visibility="Collapsed"/>
                        </Grid>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="{DynamicResource BackgroundBrush}"/>
                                <Setter TargetName="Border" Property="BorderThickness" Value="1,1,1,0"/>
                                <Setter TargetName="Border" Property="Margin" Value="2,-2,0,0"/>
                                <Setter TargetName="ActiveIndicator" Property="Visibility" Value="Visible"/>
                                <Setter TargetName="ActiveIndicator" Property="Margin" Value="3,-1,1,0"/>
                                <Setter Property="FontWeight" Value="SemiBold"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="{DynamicResource HoverBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Menu -->
        <Menu Grid.Row="0" Background="{DynamicResource SurfaceBrush}" Foreground="{DynamicResource ForegroundBrush}">
            <MenuItem Header="_File">
                <MenuItem Header="_Export Layout..." Click="ExportLayout_Click"/>
                <MenuItem Header="_Import Layout..." Click="ImportLayout_Click"/>
                <Separator/>
                <MenuItem Header="E_xit" Click="Exit_Click"/>
            </MenuItem>
            <MenuItem Header="_View">
                <MenuItem Header="_Add View" Command="{Binding AddViewCommand}"/>
                <MenuItem Header="_Edit View..." Command="{Binding EditViewCommand}" CommandParameter="{Binding SelectedView}"/>
                <MenuItem Header="_Remove View" Command="{Binding RemoveViewCommand}" CommandParameter="{Binding SelectedView}"/>
                <MenuItem Header="_Duplicate View" Command="{Binding DuplicateViewCommand}" CommandParameter="{Binding SelectedView}"/>
                <Separator/>
                <MenuItem Header="_Clear All" Command="{Binding ClearAllCommand}"/>
                <MenuItem Header="Clear _Log" Command="{Binding ClearLogCommand}"/>
                <MenuItem Header="Clear _Watches" Command="{Binding ClearWatchesCommand}"/>
                <MenuItem Header="Clear _Process Flow" Command="{Binding ClearProcessFlowCommand}"/>
                <Separator/>
                <MenuItem Header="_Panels">
                    <MenuItem Header="_Watches" IsCheckable="True" IsChecked="{Binding ShowWatchesPanel}"/>
                    <MenuItem Header="_Process Flow" IsCheckable="True" IsChecked="{Binding ShowProcessFlowPanel}"/>
                    <MenuItem Header="_Details" IsCheckable="True" IsChecked="{Binding ShowDetailsPanel}"/>
                </MenuItem>
                <MenuItem Header="_Theme">
                    <MenuItem Header="_Dark Theme" Click="DarkTheme_Click" IsCheckable="True" x:Name="DarkThemeMenuItem" IsChecked="True"/>
                    <MenuItem Header="_Light Theme" Click="LightTheme_Click" IsCheckable="True" x:Name="LightThemeMenuItem"/>
                </MenuItem>
            </MenuItem>
            <MenuItem Header="_Tools">
                <MenuItem Header="_Settings..." Click="Settings_Click"/>
            </MenuItem>
            <MenuItem Header="_Help">
                <MenuItem Header="_Icon Legend..." Click="IconLegend_Click"/>
                <Separator/>
                <MenuItem Header="_About" Click="About_Click"/>
            </MenuItem>
        </Menu>

        <!-- Toolbar -->
        <ToolBarTray Grid.Row="1" Background="{DynamicResource SurfaceBrush}">
            <ToolBar Background="{DynamicResource SurfaceBrush}" Foreground="{DynamicResource ForegroundBrush}">
                <Button Command="{Binding StartCommand}" ToolTip="Start Listening">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="&#x25B6;" Foreground="LimeGreen" FontSize="12" Margin="0,0,4,0"/>
                        <TextBlock Text="Start"/>
                    </StackPanel>
                </Button>
                <Button Command="{Binding StopCommand}" ToolTip="Stop Listening">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="&#x25A0;" Foreground="Red" FontSize="12" Margin="0,0,4,0"/>
                        <TextBlock Text="Stop"/>
                    </StackPanel>
                </Button>
                <Separator/>
                <Button Command="{Binding ClearAllCommand}" ToolTip="Clear All">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="&#x1F5D1;" FontSize="12" Margin="0,0,4,0"/>
                        <TextBlock Text="Clear"/>
                    </StackPanel>
                </Button>
                <Separator/>
                <Button Command="{Binding AddViewCommand}" ToolTip="Add New View">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="+" FontSize="14" FontWeight="Bold" Margin="0,0,4,0"/>
                        <TextBlock Text="Add View"/>
                    </StackPanel>
                </Button>
                <Button Command="{Binding EditViewCommand}" CommandParameter="{Binding SelectedView}" ToolTip="Edit View Filters">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="&#x2699;" FontSize="14" Margin="0,0,4,0"/>
                        <TextBlock Text="Edit View"/>
                    </StackPanel>
                </Button>
            </ToolBar>
        </ToolBarTray>

        <!-- Main Content -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="{Binding ShowDetailsPanel, Converter={StaticResource BoolToGridLengthConverter}}"/>
            </Grid.ColumnDefinitions>

            <!-- Left Panel -->
            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="2*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="{Binding HasDetailTabs, Converter={StaticResource BoolToGridLengthConverter}, ConverterParameter=1.5}"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="{Binding ShowWatchesPanel, Converter={StaticResource BoolToGridLengthConverter}}"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="{Binding ShowProcessFlowPanel, Converter={StaticResource BoolToGridLengthConverter}}"/>
                </Grid.RowDefinitions>

                <!-- Log Entries with Tabbed Views -->
                <TabControl Grid.Row="0"
                            ItemsSource="{Binding Views}"
                            SelectedItem="{Binding SelectedView}"
                            Margin="4"
                            behaviors:TabReorderBehavior.EnableReorder="True">
                    <TabControl.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Add View" Command="{Binding AddViewCommand}"/>
                            <MenuItem Header="Edit View..." Command="{Binding EditViewCommand}" CommandParameter="{Binding SelectedView}"/>
                            <MenuItem Header="Duplicate View" Command="{Binding DuplicateViewCommand}" CommandParameter="{Binding SelectedView}"/>
                            <MenuItem Header="Remove View" Command="{Binding RemoveViewCommand}" CommandParameter="{Binding SelectedView}"/>
                            <Separator/>
                            <MenuItem Header="Clear View Log" Command="{Binding ClearViewLogCommand}" CommandParameter="{Binding SelectedView}"
                                      ToolTip="Clear only the log entries visible in this view"/>
                            <MenuItem Header="Clear All Logs" Command="{Binding ClearLogCommand}"
                                      ToolTip="Clear all log entries from all views"/>
                            <Separator/>
                            <MenuItem Header="Show Panels">
                                <MenuItem Header="Watches" IsCheckable="True" IsChecked="{Binding ShowWatchesPanel}"/>
                                <MenuItem Header="Process Flow" IsCheckable="True" IsChecked="{Binding ShowProcessFlowPanel}"/>
                                <MenuItem Header="Details" IsCheckable="True" IsChecked="{Binding ShowDetailsPanel}"/>
                            </MenuItem>
                        </ContextMenu>
                    </TabControl.ContextMenu>
                    <TabControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding Name}" VerticalAlignment="Center"/>
                                <TextBlock Text=" (" VerticalAlignment="Center" Foreground="{DynamicResource ForegroundSecondaryBrush}"/>
                                <TextBlock Text="{Binding FilteredCount}" VerticalAlignment="Center" Foreground="{DynamicResource ForegroundSecondaryBrush}"/>
                                <TextBlock Text=")" VerticalAlignment="Center" Foreground="{DynamicResource ForegroundSecondaryBrush}"/>
                                <Button Content="&#x2699;"
                                        Command="{Binding DataContext.EditViewCommand, RelativeSource={RelativeSource AncestorType=TabControl}}"
                                        CommandParameter="{Binding}"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="4,0"
                                        Margin="6,0,0,0"
                                        FontSize="10"
                                        VerticalAlignment="Center"
                                        ToolTip="Edit View Filters"/>
                                <Button Content="x"
                                        Command="{Binding DataContext.RemoveViewCommand, RelativeSource={RelativeSource AncestorType=TabControl}}"
                                        CommandParameter="{Binding}"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="4,0"
                                        Margin="2,0,0,0"
                                        FontSize="10"
                                        VerticalAlignment="Center"
                                        ToolTip="Close View"
                                        Visibility="{Binding CanClose, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            </StackPanel>
                        </DataTemplate>
                    </TabControl.ItemTemplate>
                    <TabControl.ContentTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>

                                <!-- View Filters -->
                                <Border Grid.Row="0" Background="{DynamicResource SurfaceBrush}" Padding="8,4" Margin="0,0,0,4">
                                    <WrapPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,16,0"
                                                    Visibility="{Binding ShowAppColumn, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="App:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <TextBox Width="120" Text="{Binding AppNameFilter, UpdateSourceTrigger=PropertyChanged}"
                                                     ToolTip="Filter by application name"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,16,0"
                                                    Visibility="{Binding ShowSessionColumn, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="Session:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <TextBox Width="120" Text="{Binding SessionFilter, UpdateSourceTrigger=PropertyChanged}"
                                                     ToolTip="Filter by session name"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,16,0"
                                                    Visibility="{Binding ShowTitleColumn, Converter={StaticResource BoolToVisibilityConverter}}">
                                            <TextBlock Text="Text:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <TextBox Width="150" Text="{Binding TextFilter, UpdateSourceTrigger=PropertyChanged}"
                                                     ToolTip="Filter by title or data content"/>
                                        </StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                                            <TextBlock Text="Level:" VerticalAlignment="Center" Margin="0,0,4,0"/>
                                            <ComboBox Width="100"
                                                      ItemsSource="{Binding LogLevels}"
                                                      SelectedItem="{Binding SelectedLogLevel}"
                                                      DisplayMemberPath="DisplayName"
                                                      ToolTip="Minimum log level"/>
                                        </StackPanel>
                                        <ToggleButton IsChecked="{Binding AutoScroll}"
                                                      ToolTip="Auto-scroll to newest entries"
                                                      Padding="8,4"
                                                      Background="{DynamicResource SurfaceBrush}"
                                                      BorderBrush="{DynamicResource BorderBrush}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="&#x2193;" FontSize="12" Margin="0,0,4,0"/>
                                                <TextBlock Text="Auto"/>
                                            </StackPanel>
                                        </ToggleButton>
                                        <Button ToolTip="Clear this view's log entries"
                                                Padding="8,4"
                                                Margin="8,0,0,0"
                                                Background="{DynamicResource SurfaceBrush}"
                                                BorderBrush="{DynamicResource BorderBrush}"
                                                Command="{Binding DataContext.ClearViewLogCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                CommandParameter="{Binding}">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="&#x2715;" FontSize="12" Margin="0,0,4,0"/>
                                                <TextBlock Text="Clear"/>
                                            </StackPanel>
                                        </Button>
                                    </WrapPanel>
                                </Border>

                                <!-- Log Entries List -->
                                <ListView Grid.Row="1"
                                          ItemsSource="{Binding FilteredLogEntries}"
                                          SelectedItem="{Binding SelectedLogEntry}"
                                          VirtualizingPanel.IsVirtualizing="True"
                                          VirtualizingPanel.VirtualizationMode="Recycling"
                                          ScrollViewer.CanContentScroll="True"
                                          MouseDoubleClick="LogEntryList_MouseDoubleClick"
                                          behaviors:AutoScrollBehavior.AutoScroll="{Binding AutoScroll}">
                                    <ListView.View>
                                        <GridView>
                                            <GridViewColumn Header="" Width="30">
                                                <GridViewColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding LogEntryType, Converter={StaticResource LogEntryTypeToIconConverter}}"
                                                                   Foreground="{Binding LogEntryType, Converter={StaticResource LogEntryTypeToColorConverter}}"
                                                                   FontSize="14"
                                                                   ToolTip="{Binding LogEntryType}"/>
                                                    </DataTemplate>
                                                </GridViewColumn.CellTemplate>
                                            </GridViewColumn>
                                            <GridViewColumn Header="Time"
                                                            Width="{Binding ShowTimeColumn, Converter={StaticResource BoolToColumnWidthConverter}, ConverterParameter=90}"
                                                            DisplayMemberBinding="{Binding Timestamp, StringFormat=HH:mm:ss.fff}"/>
                                            <GridViewColumn Header="Elapsed"
                                                            Width="{Binding ShowElapsedColumn, Converter={StaticResource BoolToColumnWidthConverter}, ConverterParameter=70}"
                                                            DisplayMemberBinding="{Binding ElapsedTimeFormatted}"/>
                                            <GridViewColumn Header="App"
                                                            Width="{Binding ShowAppColumn, Converter={StaticResource BoolToColumnWidthConverter}, ConverterParameter=100}"
                                                            DisplayMemberBinding="{Binding AppName}"/>
                                            <GridViewColumn Header="Session"
                                                            Width="{Binding ShowSessionColumn, Converter={StaticResource BoolToColumnWidthConverter}, ConverterParameter=80}"
                                                            DisplayMemberBinding="{Binding SessionName}"/>
                                            <GridViewColumn Header="Title"
                                                            Width="{Binding ShowTitleColumn, Converter={StaticResource BoolToColumnWidthConverter}, ConverterParameter=350}">
                                                <GridViewColumn.CellTemplate>
                                                    <DataTemplate>
                                                        <Grid>
                                                            <!-- Normal title text -->
                                                            <TextBlock Text="{Binding Title}"
                                                                       Visibility="{Binding LogEntryType, Converter={StaticResource LogEntryToIsSeparatorConverter}, ConverterParameter=invert}"/>
                                                            <!-- Separator line -->
                                                            <Grid Visibility="{Binding LogEntryType, Converter={StaticResource LogEntryToIsSeparatorConverter}}">
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*"/>
                                                                    <ColumnDefinition Width="Auto"/>
                                                                    <ColumnDefinition Width="*"/>
                                                                </Grid.ColumnDefinitions>
                                                                <Rectangle Grid.Column="0" Height="1" Fill="{DynamicResource BorderBrush}" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                                                <TextBlock Grid.Column="1" Text="{Binding Title}" Foreground="{DynamicResource ForegroundSecondaryBrush}" FontStyle="Italic" VerticalAlignment="Center"/>
                                                                <Rectangle Grid.Column="2" Height="1" Fill="{DynamicResource BorderBrush}" VerticalAlignment="Center" Margin="8,0,0,0"/>
                                                            </Grid>
                                                        </Grid>
                                                    </DataTemplate>
                                                </GridViewColumn.CellTemplate>
                                            </GridViewColumn>
                                            <GridViewColumn Header="Thread"
                                                            Width="{Binding ShowThreadColumn, Converter={StaticResource BoolToColumnWidthConverter}, ConverterParameter=50}"
                                                            DisplayMemberBinding="{Binding ThreadId}"/>
                                        </GridView>
                                    </ListView.View>
                                </ListView>
                            </Grid>
                        </DataTemplate>
                    </TabControl.ContentTemplate>
                </TabControl>

                <GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch"
                              Background="{DynamicResource BorderBrush}" ResizeDirection="Rows"
                              Visibility="{Binding HasDetailTabs, Converter={StaticResource BoolToVisibilityConverter}}"/>

                <!-- Detail Tabs -->
                <TabControl Grid.Row="2"
                            ItemsSource="{Binding DetailTabs}"
                            SelectedItem="{Binding SelectedDetailTab}"
                            Margin="4"
                            Visibility="{Binding HasDetailTabs, Converter={StaticResource BoolToVisibilityConverter}}">
                    <TabControl.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding TabTitle}" VerticalAlignment="Center"/>
                                <Button Content="x"
                                        Command="{Binding DataContext.CloseDetailTabCommand, RelativeSource={RelativeSource AncestorType=TabControl}}"
                                        CommandParameter="{Binding}"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="4,0"
                                        Margin="6,0,0,0"
                                        FontSize="10"
                                        VerticalAlignment="Center"
                                        ToolTip="Close Tab"/>
                            </StackPanel>
                        </DataTemplate>
                    </TabControl.ItemTemplate>
                    <TabControl.ContentTemplate>
                        <DataTemplate>
                            <views:LogEntryDetailView DataContext="{Binding}"/>
                        </DataTemplate>
                    </TabControl.ContentTemplate>
                </TabControl>

                <GridSplitter Grid.Row="3" Height="5" HorizontalAlignment="Stretch"
                              Background="{DynamicResource BorderBrush}" ResizeDirection="Rows"
                              Visibility="{Binding ShowWatchesPanel, Converter={StaticResource BoolToVisibilityConverter}}"/>

                <!-- Watches -->
                <GroupBox Grid.Row="4" Header="Watches" Margin="4"
                          Visibility="{Binding ShowWatchesPanel, Converter={StaticResource BoolToVisibilityConverter}}">
                    <GroupBox.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Clear Watches" Command="{Binding ClearWatchesCommand}"/>
                            <Separator/>
                            <MenuItem Header="Hide Panel" Command="{Binding HideWatchesPanelCommand}"/>
                        </ContextMenu>
                    </GroupBox.ContextMenu>
                    <ListView ItemsSource="{Binding Watches}"
                              VirtualizingPanel.IsVirtualizing="True">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header="Name" Width="150" DisplayMemberBinding="{Binding Name}"/>
                                <GridViewColumn Header="Value" Width="200" DisplayMemberBinding="{Binding Value}"/>
                                <GridViewColumn Header="Type" Width="80" DisplayMemberBinding="{Binding WatchType}"/>
                                <GridViewColumn Header="Time" Width="90" DisplayMemberBinding="{Binding Timestamp, StringFormat=HH:mm:ss.fff}"/>
                            </GridView>
                        </ListView.View>
                    </ListView>
                </GroupBox>

                <GridSplitter Grid.Row="5" Height="5" HorizontalAlignment="Stretch"
                              Background="{DynamicResource BorderBrush}" ResizeDirection="Rows"
                              Visibility="{Binding ShowProcessFlowPanel, Converter={StaticResource BoolToVisibilityConverter}}"/>

                <!-- Process Flow -->
                <GroupBox Grid.Row="6" Header="Process Flow" Margin="4"
                          Visibility="{Binding ShowProcessFlowPanel, Converter={StaticResource BoolToVisibilityConverter}}">
                    <GroupBox.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="Clear Process Flow" Command="{Binding ClearProcessFlowCommand}"/>
                            <Separator/>
                            <MenuItem Header="Hide Panel" Command="{Binding HideProcessFlowPanelCommand}"/>
                        </ContextMenu>
                    </GroupBox.ContextMenu>
                    <ListView ItemsSource="{Binding ProcessFlows}"
                              VirtualizingPanel.IsVirtualizing="True">
                        <ListView.View>
                            <GridView>
                                <GridViewColumn Header="Type" Width="100" DisplayMemberBinding="{Binding ProcessFlowType}"/>
                                <GridViewColumn Header="Title" Width="250" DisplayMemberBinding="{Binding Title}"/>
                                <GridViewColumn Header="Thread" Width="60" DisplayMemberBinding="{Binding ThreadId}"/>
                                <GridViewColumn Header="Time" Width="90" DisplayMemberBinding="{Binding Timestamp, StringFormat=HH:mm:ss.fff}"/>
                            </GridView>
                        </ListView.View>
                    </ListView>
                </GroupBox>
            </Grid>

            <GridSplitter Grid.Column="1" Width="5" HorizontalAlignment="Center"
                          VerticalAlignment="Stretch" Background="{DynamicResource BorderBrush}"
                          Visibility="{Binding ShowDetailsPanel, Converter={StaticResource BoolToVisibilityConverter}}"/>

            <!-- Right Panel - Details -->
            <GroupBox Grid.Column="2" Header="Details" Margin="4"
                      Visibility="{Binding ShowDetailsPanel, Converter={StaticResource BoolToVisibilityConverter}}">
                <GroupBox.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="Hide Panel" Command="{Binding HideDetailsPanelCommand}"/>
                    </ContextMenu>
                </GroupBox.ContextMenu>
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Margin="8" DataContext="{Binding SelectedView.SelectedLogEntry}">
                        <TextBlock Text="Title:" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox Text="{Binding Title, Mode=OneWay}" IsReadOnly="True"
                                 TextWrapping="Wrap" Margin="0,0,0,12"/>

                        <TextBlock Text="App:" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox Text="{Binding AppName, Mode=OneWay}" IsReadOnly="True"
                                 Margin="0,0,0,12"/>

                        <TextBlock Text="Session:" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox Text="{Binding SessionName, Mode=OneWay}" IsReadOnly="True"
                                 Margin="0,0,0,12"/>

                        <TextBlock Text="Timestamp:" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox Text="{Binding Timestamp, Mode=OneWay, StringFormat=yyyy-MM-dd HH:mm:ss.fff}"
                                 IsReadOnly="True" Margin="0,0,0,12"/>

                        <TextBlock Text="Type:" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox Text="{Binding LogEntryType, Mode=OneWay}" IsReadOnly="True"
                                 Margin="0,0,0,12"/>

                        <TextBlock Text="Host:" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox Text="{Binding HostName, Mode=OneWay}" IsReadOnly="True"
                                 Margin="0,0,0,12"/>

                        <TextBlock Text="Process/Thread:" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox IsReadOnly="True" Margin="0,0,0,12">
                            <TextBox.Text>
                                <MultiBinding StringFormat="{}{0} / {1}">
                                    <Binding Path="ProcessId"/>
                                    <Binding Path="ThreadId"/>
                                </MultiBinding>
                            </TextBox.Text>
                        </TextBox>

                        <TextBlock Text="Data:" FontWeight="Bold" Margin="0,0,0,4"/>
                        <TextBox Text="{Binding DataAsString, Mode=OneWay}" IsReadOnly="True"
                                 TextWrapping="Wrap" AcceptsReturn="True"
                                 MaxHeight="300" VerticalScrollBarVisibility="Auto"
                                 FontFamily="Consolas"/>
                    </StackPanel>
                </ScrollViewer>
            </GroupBox>
        </Grid>

        <!-- Status Bar -->
        <StatusBar Grid.Row="3" Background="{DynamicResource SurfaceBrush}" Foreground="{DynamicResource ForegroundBrush}">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusText}"/>
            </StatusBarItem>
            <Separator Background="{DynamicResource BorderBrush}"/>
            <StatusBarItem>
                <StackPanel Orientation="Horizontal">
                    <Ellipse Width="10" Height="10" Margin="0,0,4,0">
                        <Ellipse.Style>
                            <Style TargetType="Ellipse">
                                <Setter Property="Fill" Value="Gray"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsListening}" Value="True">
                                        <Setter Property="Fill" Value="LimeGreen"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </Ellipse.Style>
                    </Ellipse>
                    <TextBlock>
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Foreground" Value="{DynamicResource ForegroundBrush}"/>
                                <Setter Property="Text" Value="Stopped"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsListening}" Value="True">
                                        <Setter Property="Text" Value="Listening"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </StackPanel>
            </StatusBarItem>
            <Separator Background="{DynamicResource BorderBrush}"/>
            <StatusBarItem>
                <TextBlock Text="{Binding TcpStatus}"/>
            </StatusBarItem>
            <Separator Background="{DynamicResource BorderBrush}"/>
            <StatusBarItem>
                <TextBlock Text="{Binding PipeStatus}"/>
            </StatusBarItem>
            <Separator Background="{DynamicResource BorderBrush}"/>
            <StatusBarItem>
                <TextBlock Text="{Binding EntryCount, StringFormat=Total: {0}}"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
